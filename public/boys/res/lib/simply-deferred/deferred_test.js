(function(){var e,t,n,r,i,s,o=[].slice;r=require("./deferred"),e=require("assert"),s=require("underscore"),i=["done","fail","progress","always","state","then","pipe"],t=function(t){var n,r,o,u;u=[];for(r=0,o=i.length;r<o;r++)n=i[r],u.push(e(s.has(t,n)));return u},n=function(e){return t(e)},describe("deferred",function(){return it("should create and return a deferred object",function(){var t;return t=new r.Deferred,e.equal(t.state(),"pending")}),it("should maintain a resolved state",function(){var t;return t=new r.Deferred,e.equal(t.state(),"pending"),t.resolve(),e.equal(t.state(),"resolved"),t.resolve(),e.equal(t.state(),"resolved"),t.reject(),e.equal(t.state(),"resolved")}),it("should maintain a rejected state",function(){var t;return t=new r.Deferred,e.equal(t.state(),"pending"),t.reject(),e.equal(t.state(),"rejected"),t.reject(),e.equal(t.state(),"rejected"),t.resolve(),e.equal(t.state(),"rejected")}),it("should maintain a pending state",function(){var t;return t=new r.Deferred,e.equal(t.state(),"pending"),t.notify(),e.equal(t.state(),"pending")}),it("should call all the done callbacks",function(e){var t,n;return n=new r.Deferred,t=s.after(8,e),n.done(t).done([t,t]),n.resolve(),n.done(t,t),n.reject(),n.done(t,[t,t]),n.fail(t,t)}),it("should scope done callbacks when using resolveWith",function(t){var n,i,o,u;return n=s.after(2,t),i=new r.Deferred,u={finisher:n},o=function(t){return e.equal(42,t),this.finisher()},i.done(o),i.always(function(){return n()}),i.resolveWith(u,[42]),e.equal(i.state(),"resolved")}),it("should return a deferred for empty calls",function(){return n((new r.Deferred).resolveWith())}),it("should not mangle arrays",function(){var t;return t=new r.Deferred,t.promise().done(function(t,n){return e.equal(t,1),e.equal(n,2)}),t.resolveWith(t,[1,2])}),it("should scope fail callbacks when using rejectWith",function(t){var n,i,o,u;return n=s.after(2,t),i=new r.Deferred,u={finisher:n},o=function(t){return e.equal(42,t),this.finisher()},i.fail(o),i.always(function(){return n()}),i.rejectWith(u,[42]),e.equal(i.state(),"rejected")}),it("should call all the fail callbacks",function(e){var t,n;return n=new r.Deferred,t=s.after(8,e),n.fail(t).fail([t,t]),n.reject(),n.fail(t,t),n.resolve(),n.fail(t,[t,t]),n.done(t)}),it("should scope progress callbacks when using notifyWith",function(t){var n,i,o,u;return n=s.after(2,t),i=new r.Deferred,u={finisher:n},o=function(t){return e.equal(42,t),this.finisher()},i.progress(o),i.progress(function(){return n()}),i.notifyWith(u,[42]),e.equal(i.state(),"pending")}),it("should call all the progress callbacks each notification",function(e){var t,n;return n=new r.Deferred,t=s.after(9,e),n.progress(t).progress([t,t]),n.notify(),n.progress(t).progress([t,t]),n.notify()}),it("should call progress callbacks with updated arguments on each notification",function(t){var n,i,s;return i=new r.Deferred,s=0,n=function(n){e.equal(n,s);if(n===2)return t()},i.progress(n),i.notify(s),s++,i.notify(s),s++,i.notify(s)}),it("should run notify callbacks and then accept resolution",function(t){var n,i;return i=new r.Deferred,n=s.after(2,t),i.progress(n),i.notify(),e.equal(i.state(),"pending"),i.done(n),i.resolve()}),it("should run notify callbacks and then accept rejection",function(t){var n,i;return i=new r.Deferred,n=s.after(2,t),i.progress(n),i.notify(),e.equal(i.state(),"pending"),i.fail(n),i.reject()}),it("should not run notify callbacks after being resolved",function(e){var t,n;return n=new r.Deferred,t=s.after(2,e),n.progress(t),n.notify(),n.done(t),n.resolve(),n.notify()}),it("should run additional progress callbacks imediately after being resolved",function(t){var n,i;return i=new r.Deferred,n=s.after(3,t),i.progress(n),i.notify(),i.done(n),i.resolve(),e.equal(i.state(),"resolved"),i.progress(n)}),it("should run additional progress callbacks imediately after being rejected",function(t){var n,i;return i=new r.Deferred,n=s.after(3,t),i.progress(n),i.notify(),i.fail(n),i.reject(),e.equal(i.state(),"rejected"),i.progress(n)}),it("should run additional progress callbacks with the last sent notify arguments",function(e){var t,n;return n=new r.Deferred,t=s.after(3,function(t){if(t===2)return e()}),n.progress(t),n.notify(1),n.notify(2),n.resolve(5),n.progress(t)}),it("should call all the always callbacks on resolution",function(e){var t,n;return n=new r.Deferred,t=s.after(8,e),n.always(t).always([t,t]),n.resolve(),n.always(t,t),n.always(t,[t,t]),n.fail(t)}),it("should call the always callbacks on rejection",function(e){var t;return t=new r.Deferred,t.always(e),t.reject(),t.done(e)}),it("should call callbacks with arguments",function(e){var t,n;return n=s.after(8,e),t=function(e,t){if(e===42&&t===24)return n()},(new r.Deferred).always(t).resolve(42,24).always(t),(new r.Deferred).always(t).reject(42,24).always(t),(new r.Deferred).done(t).resolve(42,24).done(t),(new r.Deferred).fail(t).reject(42,24).fail(t)}),it("should provide a when method",function(e){var t,n,i,o,u;return n=s.after(4,function(){return e()}),i=(new r.Deferred).done(n),o=(new r.Deferred).done(n),u=(new r.Deferred).done(n),t=r.when(i,o,u).done(n),i.resolve(),o.resolve(),u.resolve()}),describe("pipe",function(){return it("should pipe on resolution",function(e){var t,n,i;return i=function(t){if(t===10)return e()},t=new r.Deferred,n=t.pipe(function(e){return e*2}),t.resolve(5),n.done(i)}),it("should pipe on rejection",function(e){var t,n,i;return i=function(t){if(t===6)return e()},t=new r.Deferred,n=t.pipe(null,function(e){return e*3}),t.reject(2),n.fail(i)}),it("should pipe on progress",function(e){var t,n,i;return i=function(t){if(t===6)return e()},t=new r.Deferred,n=t.pipe(null,null,function(e){return e*3}),n.progress(i),t.notify(2)}),it("should pipe with arrays intact",function(e){var t,n,i;return i=function(t){if(t.length===[1,2,3].length)return e()},t=new r.Deferred,n=t.pipe(null,function(e){return e.push(3),e}),t.reject([1,2]),n.fail(i)}),it("should pass through for null filters for done",function(e){var t,n,i;return i=function(t){if(t===5)return e()},t=new r.Deferred,n=t.pipe(null,null),t.resolve(5),n.done(i)}),it("should pass through for null filters for fail",function(e){var t,n,i;return i=function(t){if(t===5)return e()},t=new r.Deferred,n=t.pipe(null,null),t.reject(5),n.fail(i)}),it("should pass through for null filters for notify",function(e){var t,n,i;return i=function(t){if(t===5)return e()},t=new r.Deferred,n=t.pipe(null,null,null),n.progress(i),t.notify(5)}),it("should accept promises from filters and call them later with arguments",function(t){var n,i;return n=r.Deferred(),i=function(t){var n;return e.equal(t,"r1"),n=r.Deferred(),setTimeout(function(){return n.resolve("r2")},100),n},n.then(i).done(function(n){e.equal(n,"r2");if(n==="r2")return t()}),n.resolve("r1")}),it("should allow changing the state",function(t){var n;return n=r.Deferred(),n.pipe(function(e){return r.Deferred().reject("failure").promise()}).fail(function(n){e.equal(n,"failure");if(n==="failure")return t()}),n.resolve("r1")})}),describe("then",function(){return it("should alias pipe",function(){var t;return t=new r.Deferred,e.equal(t.then,t.pipe)})}),describe("promises",function(){return it("should provide a promise that has a restricted API",function(t){var i,o,u;return o=new r.Deferred,u=o.promise(),n(u),i=s.after(7,t),u.always(i).always(i).progress(i).fail(i).done(i).fail(i),n(u.progress(i)),n(u.done(i)),n(u.fail(i)),n(u.always(i)),e.equal("pending",u.state()),o.notify(),e.equal("pending",u.state()),o.resolve(),e.equal("resolved",u.state())}),it("should create a promise out of a given object",function(){var n,i,s;return n={id:42},i=new r.Deferred,s=i.promise(n),e.equal(n,s),t(n)}),it("should soak up extraneous promises",function(){var t,i;return t=new r.Deferred,i=t.promise().promise(),n(i),i.done(function(t){return e.equal(t,42)}),t.resolve(42)}),describe("when",function(){return it("should return a promise",function(){return n(r.when(new r.Deferred))}),it("should resolve when all deps have succeeded",function(){var t,n,i;return n=new r.Deferred,i=new r.Deferred,t=r.when(n,i),n.resolve(),e.equal(t.state(),"pending"),i.resolve(),e.equal(t.state(),"resolved")}),it("should reject when there are some failures",function(){var t,n,i;return n=new r.Deferred,i=new r.Deferred,t=r.when(n,i),n.resolve(),e.equal(t.state(),"pending"),i.reject(),e.equal(t.state(),"rejected")}),it("should pass on reject arguments",function(e){var t,n,i;return n=new r.Deferred,i=new r.Deferred,t=r.when(n,i),t.fail(function(t){if(t===42)return e()}),n.resolve(),i.reject(42)}),it("should pass on resolve arguments as is when used with a single deferred",function(t){var n,i;return i=new r.Deferred,n=r.when(i),e.equal(i,n),n.done(function(e){if(e===42)return t()}),i.resolve(42)}),it("should special case single or no arguments when using multiple deferreds",function(t){var n,i,s,o;return i=new r.Deferred,s=new r.Deferred,o=new r.Deferred,n=r.when(i,s,o),n.done(function(n,r,i){return e.equal(n,42),e.equal(r,void 0),e.deepEqual(i,["abc",123]),t()}),s.resolve(),o.resolve("abc",123),i.resolve(42)}),it("should handle non promise arguments",function(){return r.when(1,2,42).done(function(t,n,r){return e.equal(t,1),e.equal(n,2),e.equal(r,42)})}),it("should handle zero arguments",function(e){return r.when().done(e)})})}),describe("installation into a jQuery compatible library",function(){var i;return i=[42,24],it("should install .Deferred",function(){var e;return e={},r.installInto(e),t(e.Deferred())}),it("should install .when",function(){var t;return t={},r.installInto(t),e.equal(t.when.toString(),r.when.toString())}),it("should wrap .ajax()",function(e){var t;return t={},t.ajax=function(t){return e()},r.installInto(t),n(t.ajax())}),it("should resolve on success",function(e){var t,n,u,a;return t=s.after(3,e),a={},a.ajax=function(e){return e.success.apply(e,i)},r.installInto(a),u=function(){var e;e=1<=arguments.length?o.call(arguments,0):[];if(e.length===i.length)return t()},n=a.ajax({success:u}),n.done(u),n.always(u),n.fail(function(){return fail()})}),it("should provide an abort mechanism",function(e){var t,n;return n={},n.ajax=function(t){return{abort:function(){return e()}}},r.installInto(n),t=n.ajax(),t.abort()}),it("should reject on failure",function(e){var t,n,u,a;return t=s.after(3,e),a={},a.ajax=function(e){return e.error.apply(e,i)},r.installInto(a),n=function(){var e;e=1<=arguments.length?o.call(arguments,0):[];if(e.length===i.length)return t()},u=a.ajax({error:n}),u.fail(n),u.always(n),u.done(function(){return fail()})}),it("should work when no ajax callbacks are provided",function(e){var t;return t={},t.ajax=function(e){return e.success()},r.installInto(t),t.ajax({success:null}).done(e)})})})}).call(this);